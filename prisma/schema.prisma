// File: prisma/schema.prisma (Final Version with suggestions)

generator client {
  provider        = "prisma-client-js"
  previewFeatures = ["fullTextIndex"]
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

// ===============================================
//  Enums (กลุ่มของค่าคงที่)
// ===============================================
enum OrderStatus {
  COMPLETED
  CREDIT
  HELD
  CANCELLED
}

enum BillingNoteStatus {
  PENDING
  PAID
  CANCELLED
}

// ===============================================
//  Model: PurchaseOrder (ใบสั่งซื้อ/ใบรับของ)
// ===============================================
model PurchaseOrder {
  id          Int                 @id @default(autoincrement())
  poNumber    String              @unique
  notes       String?             @db.Text
  totalCost   Decimal
  createdAt   DateTime            @default(now())
  supplier    Supplier            @relation(fields: [supplierId], references: [id], onDelete: Restrict, onUpdate: Cascade) // ✅ onUpdate added
  supplierId  Int
  items       PurchaseOrderItem[]
}

// ===============================================
//  Model: PurchaseOrderItem (รายการสินค้าในใบรับของ)
// ===============================================
model PurchaseOrderItem {
  id              Int           @id @default(autoincrement())
  quantity        Int
  costPrice       Decimal
  purchaseOrder   PurchaseOrder @relation(fields: [purchaseOrderId], references: [id], onDelete: Cascade, onUpdate: Cascade) // ✅ onUpdate added
  purchaseOrderId Int
  product         Product       @relation(fields: [productId], references: [id], onUpdate: Cascade) // ✅ onUpdate added
  productId       Int
}

// ===============================================
//  Model: Supplier (ข้อมูลผู้ขาย)
// ===============================================
model Supplier {
  id             Int             @id @default(autoincrement())
  code           String          @unique
  name           String
  taxId          String?
  phone          String?
  fax            String?
  email          String?
  address        String?         @db.Text
  notes          String?         @db.Text
  creditDays     Int?
  paymentTerms   String?
  imageUrl       String?
  products       Product[]
  purchaseOrders PurchaseOrder[]
  createdAt      DateTime        @default(now())
  updatedAt      DateTime        @updatedAt
}

// ===============================================
//  Model: Customer (ข้อมูลลูกค้า/สมาชิก)
// ===============================================
model Customer {
  id                   Int           @id @default(autoincrement())
  memberCode           String        @unique
  title                String?
  firstName            String
  lastName             String?
  nationalId           String?       @unique
  phone                String?
  email                String?
  dateOfBirth          DateTime?
  taxId                String?
  creditLimit          Decimal?
  address              String?       @db.Text
  shippingAddress      String?       @db.Text
  notes                String?       @db.Text
  imageUrl             String?
  membershipExpiryDate DateTime?
  orders               Order[]
  billingNotes         BillingNote[]
  createdAt            DateTime      @default(now())
  updatedAt            DateTime      @updatedAt
}

// ===============================================
//  Model: Unit (หน่วยนับสินค้า)
// ===============================================
model Unit {
  id        Int       @id @default(autoincrement())
  name      String    @unique
  products  Product[]
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
}

// ===============================================
//  Model: Category (ประเภทสินค้า)
// ===============================================
model Category {
  id        Int       @id @default(autoincrement())
  name      String    @unique
  products  Product[]
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
}

// ===============================================
//  Model: Product (ข้อมูลสินค้า)
// ===============================================
model Product {
  id                 Int                   @id @default(autoincrement())
  name               String
  alias              String?
  barcode            String?               @unique
  category           Category?             @relation(fields: [categoryId], references: [id], onDelete: SetNull, onUpdate: Cascade) // ✅ onUpdate added
  categoryId         Int?
  unit               Unit?                 @relation(fields: [unitId], references: [id], onDelete: SetNull, onUpdate: Cascade) // ✅ onUpdate added
  unitId             Int?
  costPrice          Decimal
  retailPrice        Decimal
  wholesalePrice     Decimal?
  vatType            String?
  stockQuantity      Int                   @default(0)
  trackStock         Boolean               @default(true)
  reorderPoint       Int?
  purchaseLimit      Int?
  shelfLocation      String?
  expiryDate         DateTime?
  points             Int?
  notes              String?               @db.Text
  imageUrl           String?
  allowPriceEdit     Boolean               @default(false)
  supplier           Supplier?             @relation(fields: [supplierId], references: [id], onDelete: SetNull, onUpdate: Cascade) // ✅ onUpdate added
  supplierId         Int?
  OrderItems         OrderItem[]
  purchaseOrderItems PurchaseOrderItem[]
  returns            ReturnItem[]
  createdAt          DateTime              @default(now())
  updatedAt          DateTime              @updatedAt
  @@fulltext([name, alias, barcode])
}

// ===============================================
//  Model: Order (ข้อมูลบิลการขาย)
// ===============================================
model Order {
  id              Int               @id @default(autoincrement())
  orderNumber     String            @unique
  total           Decimal
  received        Decimal?
  change          Decimal?
  status          OrderStatus       @default(COMPLETED)
  createdAt       DateTime          @default(now())
  customer        Customer?         @relation(fields: [customerId], references: [id], onDelete: SetNull, onUpdate: Cascade) // ✅ onUpdate added
  customerId      Int?
  items           OrderItem[]
  billingNoteItem BillingNoteItem?
  returns         ProductReturn[]
}

// ===============================================
//  Model: OrderItem (รายการสินค้าในบิล)
// ===============================================
model OrderItem {
  id               Int     @id @default(autoincrement())
  quantity         Int
  price            Decimal
  discount         Decimal @default(0)
  order            Order   @relation(fields: [orderId], references: [id], onDelete: Cascade, onUpdate: Cascade) // ✅ onUpdate added
  orderId          Int
  product          Product @relation(fields: [productId], references: [id], onDelete: Restrict, onUpdate: Cascade) // ✅ onUpdate added
  productId        Int
  returnedQuantity Int     @default(0)
}

// ===============================================
//  Model: ProductReturn (หัวบิลการรับคืน)
// ===============================================
model ProductReturn {
  id                Int          @id @default(autoincrement())
  originalOrderId   Int
  totalRefundAmount Decimal
  reason            String?
  createdAt         DateTime     @default(now())
  originalOrder     Order        @relation(fields: [originalOrderId], references: [id], onDelete: Restrict, onUpdate: Cascade) // ✅ onUpdate added
  items             ReturnItem[]
  @@map("product_returns")
}

// ===============================================
//  Model: ReturnItem (รายการสินค้าที่รับคืน)
// ===============================================
model ReturnItem {
  id              Int           @id @default(autoincrement())
  productReturnId Int
  productId       Int
  quantity        Int
  priceAtReturn   Decimal
  productReturn   ProductReturn @relation(fields: [productReturnId], references: [id], onDelete: Cascade, onUpdate: Cascade) // ✅ onUpdate added
  product         Product       @relation(fields: [productId], references: [id], onUpdate: Cascade) // ✅ onUpdate added
  @@map("return_items")
}

// ===============================================
//  Models สำหรับ Authentication (Lucia Auth)
// ===============================================
model User {
  id       String    @id
  username String    @unique
  password String
  role     String    @default("USER")
  sessions Session[]
}

model Session {
  id        String   @id
  expiresAt DateTime
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade, onUpdate: Cascade) // ✅ onUpdate added
}

// ===============================================
//  Model: BillingNote (ใบวางบิล/ใบแจ้งหนี้)
// ===============================================
model BillingNote {
  id          Int               @id @default(autoincrement())
  bnNumber    String            @unique
  totalAmount Decimal
  status      BillingNoteStatus @default(PENDING)
  paidAt      DateTime?
  createdAt   DateTime          @default(now())
  customer    Customer          @relation(fields: [customerId], references: [id], onDelete: Restrict, onUpdate: Cascade) // ✅ onUpdate added
  customerId  Int
  items       BillingNoteItem[]
}

// ===============================================
//  Model: BillingNoteItem (รายการบิลในใบวางบิล)
// ===============================================
model BillingNoteItem {
  id            Int         @id @default(autoincrement())
  billingNote   BillingNote @relation(fields: [billingNoteId], references: [id], onDelete: Cascade, onUpdate: Cascade) // ✅ onUpdate added
  billingNoteId Int
  order         Order       @relation(fields: [orderId], references: [id], onUpdate: Cascade) // ✅ onUpdate added
  orderId       Int         @unique
}

// ===============================================
//  ✨ NEW MODEL: Settings (การตั้งค่าระบบ)
// ===============================================
model Settings {
  id            Int      @id @default(1) // ใช้ ID คงที่เป็น 1 เพื่อให้มีแค่แถวเดียว
  storeName     String   @default("My POS Store")
  address       String?  @db.Text
  phone         String?
  taxId         String?
  defaultVat    Decimal  @default(7.00)
  receiptNote   String?  @db.Text
  receiptLogoUrl String?
  updatedAt     DateTime @updatedAt
}